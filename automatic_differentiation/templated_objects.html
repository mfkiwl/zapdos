<!DOCTYPE html><head><meta charset="UTF-8"><title>Supporting both AD and non AD variables through templating | Zapdos</title><link href="../contrib/materialize/materialize.min.css" type="text/css" rel="stylesheet" media="screen,projection"></link><link href="../contrib/prism/prism.min.css" type="text/css" rel="stylesheet"></link><link href="../css/moose.css" type="text/css" rel="stylesheet"></link><link href="../css/devel_moose.css" type="text/css" rel="stylesheet"></link><link href="../css/alert_moose.css" type="text/css" rel="stylesheet"></link><link href="../css/content_moose.css" type="text/css" rel="stylesheet"></link><link href="../css/sqa_moose.css" type="text/css" rel="stylesheet"></link><link href="../css/civet_moose.css" type="text/css" rel="stylesheet"></link><link href="../css/zapdos.css" type="text/css" rel="stylesheet"></link><script type="text/javascript" src="../contrib/jquery/jquery.min.js"></script></head><body><div class="page-wrap"><header><nav><div class="nav-wrapper container"><a href="../index.html" class="left moose-logo hide-on-med-and-down" id="home-button">Zapdos</a><a href="https://github.com/shannon-lab/zapdos" class="right"><img src="../media/framework/github-logo.png" class="github-mark"></img><img src="../media/framework/github-mark.png" class="github-logo"></img></a><ul class="right hide-on-med-and-down"><li><a href="#!" class="dropdown-trigger" data-target="ae90da9c-9025-4a8f-9f82-aa9755c98d76" data-constrainWidth="false">Getting Started<i class="material-icons right">arrow_drop_down</i></a></li><li><a href="#!" class="dropdown-trigger" data-target="2e69c805-f3fb-4824-ab7d-a876760b7f89" data-constrainWidth="false">Documentation<i class="material-icons right">arrow_drop_down</i></a></li><li><a href="#!" class="dropdown-trigger" data-target="7825448b-26fb-4395-a2cd-d9945484e2f5" data-constrainWidth="false">Help<i class="material-icons right">arrow_drop_down</i></a></li><li><a href="../citing.html">Citing</a></li></ul><a href="#" class="sidenav-trigger" data-target="6e095e5b-da4d-4a5b-a6a0-005ef9f42a3e"><i class="material-icons">menu</i></a><ul class="sidenav" id="6e095e5b-da4d-4a5b-a6a0-005ef9f42a3e"><li><a href="#!" class="dropdown-trigger" data-target="8ee70e30-8284-4e60-8fe4-8433f5e33c9f" data-constrainWidth="false">Getting Started<i class="material-icons right">arrow_drop_down</i></a></li><li><a href="#!" class="dropdown-trigger" data-target="364b2da1-62cc-4077-bf1d-e230c234058e" data-constrainWidth="false">Documentation<i class="material-icons right">arrow_drop_down</i></a></li><li><a href="#!" class="dropdown-trigger" data-target="78d34850-39cc-4b9f-9eff-e896aed21d8d" data-constrainWidth="false">Help<i class="material-icons right">arrow_drop_down</i></a></li><li><a href="../citing.html">Citing</a></li></ul><a href="#moose-search" class="modal-trigger"><i class="material-icons">search</i></a></div><ul class="dropdown-content" id="ae90da9c-9025-4a8f-9f82-aa9755c98d76"><li><a href="../getting_started/installation.html">Installation</a></li><li><a href="../getting_started/using_zapdos.html">Using Zapdos</a></li><li><a href="../getting_started/zapdos_meshing.html">Generating Meshes</a></li></ul><ul class="dropdown-content" id="2e69c805-f3fb-4824-ab7d-a876760b7f89"><li><a href="../syntax/zapdos_only.html">Zapdos Input Syntax</a></li><li><a href="../syntax/index.html">Complete Code Syntax</a></li><li><a href="../doxygen/classes.html">Zapdos Doxygen</a></li><li><a href="https://mooseframework.inl.gov/docs/doxygen/moose/classes.html">MOOSE Doxygen</a></li><li><a href="https://mooseframework.inl.gov/docs/doxygen/libmesh/classes.html">libMesh Doxygen</a></li><li><a href="../a-to-z.html">Zapdos A to Z Index</a></li><li><a href="../examples/crane_examples.html">CRANE Examples</a></li><li><a href="../development/contributing.html">Contributing Guidelines</a></li><li><a href="../development/code_standards.html">Code Standards</a></li><li><a href="../publications.html">List of Publications</a></li></ul><ul class="dropdown-content" id="7825448b-26fb-4395-a2cd-d9945484e2f5"><li><a href="https://github.com/shannon-lab/zapdos/discussions">Zapdos Discussions Forum</a></li><li><a href="../development/zapdos_developer_info.html">Zapdos Developer Information</a></li><li><a href="https://github.com/idaholab/moose/discussions">MOOSE Discussions Forum</a></li><li><a href="https://mooseframework.inl.gov/">MOOSE Homepage</a></li><li><a href="../development/moose_developer_info.html">MOOSE Developer Information</a></li></ul><ul class="dropdown-content" id="8ee70e30-8284-4e60-8fe4-8433f5e33c9f"><li><a href="../getting_started/installation.html">Installation</a></li><li><a href="../getting_started/using_zapdos.html">Using Zapdos</a></li><li><a href="../getting_started/zapdos_meshing.html">Generating Meshes</a></li></ul><ul class="dropdown-content" id="364b2da1-62cc-4077-bf1d-e230c234058e"><li><a href="../syntax/zapdos_only.html">Zapdos Input Syntax</a></li><li><a href="../syntax/index.html">Complete Code Syntax</a></li><li><a href="../doxygen/classes.html">Zapdos Doxygen</a></li><li><a href="https://mooseframework.inl.gov/docs/doxygen/moose/classes.html">MOOSE Doxygen</a></li><li><a href="https://mooseframework.inl.gov/docs/doxygen/libmesh/classes.html">libMesh Doxygen</a></li><li><a href="../a-to-z.html">Zapdos A to Z Index</a></li><li><a href="../examples/crane_examples.html">CRANE Examples</a></li><li><a href="../development/contributing.html">Contributing Guidelines</a></li><li><a href="../development/code_standards.html">Code Standards</a></li><li><a href="../publications.html">List of Publications</a></li></ul><ul class="dropdown-content" id="78d34850-39cc-4b9f-9eff-e896aed21d8d"><li><a href="https://github.com/shannon-lab/zapdos/discussions">Zapdos Discussions Forum</a></li><li><a href="../development/zapdos_developer_info.html">Zapdos Developer Information</a></li><li><a href="https://github.com/idaholab/moose/discussions">MOOSE Discussions Forum</a></li><li><a href="https://mooseframework.inl.gov/">MOOSE Homepage</a></li><li><a href="../development/moose_developer_info.html">MOOSE Developer Information</a></li></ul></nav><div class="modal modal-fixed-footer moose-search-modal" id="moose-search"><div class="modal-content container moose-search-modal-content"><div class="row"><div class="col l12"><div class="input-field"><input type_="text" onkeyup="mooseSearch()" placeholder="/index.md" id="moose-search-box"></input></div></div><div><div class="col s12" id="moose-search-results"></div></div></div></div><div class="modal-footer"><a href="#!" class="modal-close btn-flat">Close</a></div></div></header><main class="main"><div class="container"><div class="row"><div class="col hide-on-med-and-down l12"><nav class="breadcrumb-nav"><div class="nav-wrapper"><a href="." class="breadcrumb">automatic_differentiation</a><a href="#" class="breadcrumb">templated_objects</a></div></nav></div></div><div class="row"><div class="moose-content col s12 m12 l10"><section id="4d91ab37-5290-4190-884c-91ee7d9e39c6" data-section-level="1" data-section-text="Supporting both AD and non - AD variables through templating"><h1 id="supporting-both-ad-and-non-ad-variables-through-templating">Supporting both AD and non-AD variables through templating</h1><p>There are a large number of classes that were written before the <span>automatic differentiation (AD)</span> system was available that cannot leverage the AD system, and cannot therefore be used with the <a href="../finite_volumes/fv_design.html">finite volume (FV)</a> system which is AD-only.</p><p>To avoid duplicating classes that a user may wish to use with the FV system, classes can be generalized to allow use with both AD and non-AD variables through templating.</p><p>These classes are templated on a bool <code>is_ad</code>, which is <code>true</code> for AD variables, and <code>false</code> for non-AD variables. Several templated methods for coupling variables and declaring/getting material properties of any type are available, such as</p><pre class="moose-pre"><code class="language-text">
coupledGenericValue&lt;is_ad&gt;(var_name)
declareGenericMaterialProperty&lt;T, is_ad&gt;(mat_prop)
getGenericMaterialProperty&lt;T, is_ad&gt;(mat_prop)
</code></pre><p>The following examples in the framework demonstrate how to template a class to use both AD and non-AD variables and material properties.</p><section class="scrollspy" id="ae7b022a-cecd-4945-9df8-df3d82557f9a" data-section-level="2" data-section-text="Materials"><h2 id="materials">Materials</h2><p>Consider the <a href="../source/materials/GenericConstantMaterial.html">GenericConstantMaterial.md</a> material. The header file defines a templated class <code>GenericConstantMaterialTempl&lt;is_ad&gt;</code> with a material property of <code>GenericMaterialProperty&lt;Real, is_ad</code> which evaluates to the correct type depending on the value of <code>is_ad</code>.</p><pre class="moose-pre" style="max-height:350px;"><code class="language-cpp">
#pragma once

#include &quot;Material.h&quot;

/**
 * This material automatically declares as material properties whatever is passed to it
 * through the parameters &#x27;prop_names&#x27; and uses the values from &#x27;prop_values&#x27; as the values
 * for those properties.
 *
 * This is not meant to be used in a production capacity... and instead is meant to be used
 * during development phases for ultimate flexibility.
 */
template &lt;bool is_ad&gt;
class GenericConstantMaterialTempl : public Material
{
public:
  static InputParameters validParams();

  GenericConstantMaterialTempl(const InputParameters &amp; parameters);

protected:
  virtual void initQpStatefulProperties() override;
  virtual void computeQpProperties() override;

  const std::vector&lt;std::string&gt; &amp; _prop_names;
  const std::vector&lt;Real&gt; &amp; _prop_values;

  unsigned int _num_props;

  std::vector&lt;GenericMaterialProperty&lt;Real, is_ad&gt; *&gt; _properties;
};

typedef GenericConstantMaterialTempl&lt;false&gt; GenericConstantMaterial;
typedef GenericConstantMaterialTempl&lt;true&gt; ADGenericConstantMaterial;
</code></pre><a class="moose-source-filename tooltipped modal-trigger" href="#f79fa6c7-7c15-42a5-9440-5d9b278da8d1">(moose/framework/include/materials/GenericConstantMaterial.h)</a><p>Note the <code>typedef</code>&#x27;s at the end of the header: when <code>GenericConstantMaterial</code> is used in an input file, this class is instantiated with <code>is_ad = false</code>, while when <code>ADGenericConstantMaterial</code> is used, <code>is_ad = true</code>.</p><p>The corresponding source file with templated methods is</p><pre class="moose-pre" style="max-height:350px;"><code class="language-cpp">
#include &quot;GenericConstantMaterial.h&quot;

registerMooseObject(&quot;MooseApp&quot;, GenericConstantMaterial);
registerMooseObject(&quot;MooseApp&quot;, ADGenericConstantMaterial);

template &lt;bool is_ad&gt;
InputParameters
GenericConstantMaterialTempl&lt;is_ad&gt;::validParams()
{
  InputParameters params = Material::validParams();
  params.addClassDescription(
      &quot;Declares material properties based on names and values prescribed by input parameters.&quot;);
  params.addRequiredParam&lt;std::vector&lt;std::string&gt;&gt;(
      &quot;prop_names&quot;, &quot;The names of the properties this material will have&quot;);
  params.addRequiredParam&lt;std::vector&lt;Real&gt;&gt;(&quot;prop_values&quot;,
                                             &quot;The values associated with the named properties&quot;);
  params.set&lt;MooseEnum&gt;(&quot;constant_on&quot;) = &quot;SUBDOMAIN&quot;;
  params.declareControllable(&quot;prop_values&quot;);
  return params;
}

template &lt;bool is_ad&gt;
GenericConstantMaterialTempl&lt;is_ad&gt;::GenericConstantMaterialTempl(
    const InputParameters &amp; parameters)
  : Material(parameters),
    _prop_names(getParam&lt;std::vector&lt;std::string&gt;&gt;(&quot;prop_names&quot;)),
    _prop_values(getParam&lt;std::vector&lt;Real&gt;&gt;(&quot;prop_values&quot;))
{
  unsigned int num_names = _prop_names.size();
  unsigned int num_values = _prop_values.size();

  if (num_names != num_values)
    mooseError(
        &quot;Number of prop_names must match the number of prop_values for a GenericConstantMaterial!&quot;);

  _num_props = num_names;

  _properties.resize(num_names);

  for (unsigned int i = 0; i &lt; _num_props; i++)
    _properties[i] = &amp;declareGenericProperty&lt;Real, is_ad&gt;(_prop_names[i]);
}

template &lt;bool is_ad&gt;
void
GenericConstantMaterialTempl&lt;is_ad&gt;::initQpStatefulProperties()
{
  computeQpProperties();
}

template &lt;bool is_ad&gt;
void
GenericConstantMaterialTempl&lt;is_ad&gt;::computeQpProperties()
{
  for (unsigned int i = 0; i &lt; _num_props; i++)
    (*_properties[i])[_qp] = _prop_values[i];
}

template class GenericConstantMaterialTempl&lt;false&gt;;
template class GenericConstantMaterialTempl&lt;true&gt;;
</code></pre><a class="moose-source-filename tooltipped modal-trigger" href="#9418e3ef-a3c8-4c83-9441-2fbe528083e4">(moose/framework/src/materials/GenericConstantMaterial.C)</a><p>Note that both <code>GenericConstantMaterial</code> and <code>ADGenericConstantMaterial</code> are registered to the app, and the material property is declared using the templated <code>declareGenericMaterialProperty&lt;T, is_ad&gt;(mat_prop)</code>.</p></section><section class="scrollspy" id="86a5229b-9554-4809-973b-ed1c571b5c71" data-section-level="2" data-section-text="Kernels"><h2 id="kernels">Kernels</h2><p>Other classes can be templated in a similar fashion. Consider a <a href="../source/kernels/BodyForce.html">Kernel</a> example. In this case, the class is derived from the <code>GenericKernel</code> base class, to ensure that the <code>computeQpResidual()</code> method returns the correct type for both AD and non-AD variables (note that it is of type <code>GenericReal&lt;is_ad&gt;</code>). Otherwise, the basic concept is the same as before.</p><pre class="moose-pre" style="max-height:350px;"><code class="language-cpp">
#pragma once

#include &quot;GenericKernel.h&quot;

class Function;

/**
 * This kernel implements a generic functional
 * body force term:
 * $ - c \cdof f \cdot \phi_i $
 *
 * The coefficient and function both have defaults
 * equal to 1.0.
 */
template &lt;bool is_ad&gt;
class BodyForceTempl : public GenericKernel&lt;is_ad&gt;
{
public:
  static InputParameters validParams();

  BodyForceTempl(const InputParameters &amp; parameters);

protected:
  virtual GenericReal&lt;is_ad&gt; computeQpResidual() override;

  /// Scale factor
  const Real &amp; _scale;

  /// Optional function value
  const Function &amp; _function;

  /// Optional Postprocessor value
  const PostprocessorValue &amp; _postprocessor;

  // AD/non-AD version of the quadrature point coordinates
  const MooseArray&lt;MooseADWrapper&lt;Point, is_ad&gt;&gt; * _generic_q_point;

  usingGenericKernelMembers;
};

typedef BodyForceTempl&lt;false&gt; BodyForce;
typedef BodyForceTempl&lt;true&gt; ADBodyForce;
</code></pre><a class="moose-source-filename tooltipped modal-trigger" href="#08ec6d3e-d651-4826-8bdd-a0d0c26d9a7d">(moose/framework/include/kernels/BodyForce.h)</a><p>The corresponding source file is</p><pre class="moose-pre" style="max-height:350px;"><code class="language-cpp">
#include &quot;BodyForce.h&quot;

// MOOSE
#include &quot;Function.h&quot;
#include &quot;Assembly.h&quot;

registerMooseObject(&quot;MooseApp&quot;, BodyForce);
registerMooseObject(&quot;MooseApp&quot;, ADBodyForce);

template &lt;bool is_ad&gt;
InputParameters
BodyForceTempl&lt;is_ad&gt;::validParams()
{
  InputParameters params = GenericKernel&lt;is_ad&gt;::validParams();
  params.addClassDescription(&quot;Demonstrates the multiple ways that scalar values can be introduced &quot;
                             &quot;into kernels, e.g. (controllable) constants, functions, and &quot;
                             &quot;postprocessors. Implements the weak form $(\\psi_i, -f)$.&quot;);
  params.addParam&lt;Real&gt;(&quot;value&quot;, 1.0, &quot;Coefficient to multiply by the body force term&quot;);
  params.addParam&lt;FunctionName&gt;(&quot;function&quot;, &quot;1&quot;, &quot;A function that describes the body force&quot;);
  params.addParam&lt;PostprocessorName&gt;(
      &quot;postprocessor&quot;, 1, &quot;A postprocessor whose value is multiplied by the body force&quot;);
  params.declareControllable(&quot;value&quot;);
  return params;
}

template &lt;bool is_ad&gt;
BodyForceTempl&lt;is_ad&gt;::BodyForceTempl(const InputParameters &amp; parameters)
  : GenericKernel&lt;is_ad&gt;(parameters),
    _scale(this-&gt;template getParam&lt;Real&gt;(&quot;value&quot;)),
    _function(getFunction(&quot;function&quot;)),
    _postprocessor(getPostprocessorValue(&quot;postprocessor&quot;)),
    _generic_q_point(this-&gt;_use_displaced_mesh ? &amp;this-&gt;_assembly.template genericQPoints&lt;is_ad&gt;()
                                               : nullptr)
{
}

template &lt;bool is_ad&gt;
GenericReal&lt;is_ad&gt;
BodyForceTempl&lt;is_ad&gt;::computeQpResidual()
{
  if (_generic_q_point)
    return -_test[_i][_qp] * _scale * _postprocessor *
           _function.value(_t, (*_generic_q_point)[_qp]);
  else
    return -_test[_i][_qp] * _scale * _postprocessor * _function.value(_t, _q_point[_qp]);
}

template class BodyForceTempl&lt;false&gt;;
template class BodyForceTempl&lt;true&gt;;
</code></pre><a class="moose-source-filename tooltipped modal-trigger" href="#17e6b763-c8f8-4615-8e0f-2409bffbbbb6">(moose/framework/src/kernels/BodyForce.C)</a><p>One important observation in this case is that this class (<code>BodyForceTempl</code>) derives from a templated base class (<code>GenericKernel&lt;is_ad</code>). This is slightly more complicated than the material example above. Members of the base class are not available in this derived class without including them with the <code>using</code> declaration in the header file (<code>usingGenericKernelMembers</code>), which is defined in the <code>GenericKernel</code> header</p><pre class="moose-pre" style="max-height:350px;"><code class="language-cpp">
#pragma once

#include &quot;Kernel.h&quot;
#include &quot;ADKernel.h&quot;

template &lt;bool is_ad&gt;
class GenericKernel : public Kernel
{
public:
  static InputParameters validParams() { return Kernel::validParams(); };
  GenericKernel(const InputParameters &amp; parameters) : Kernel(parameters) {}
};

template &lt;&gt;
class GenericKernel&lt;true&gt; : public ADKernel
{
public:
  static InputParameters validParams() { return ADKernel::validParams(); };
  GenericKernel(const InputParameters &amp; parameters) : ADKernel(parameters) {}
};

#define usingGenericKernelMembers                                                                  \
  usingFunctionInterfaceMembers;                                                                   \
  usingPostprocessorInterfaceMembers;                                                              \
  usingMooseObjectMembers;                                                                         \
  usingTransientInterfaceMembers;                                                                  \
  usingTaggingInterfaceMembers;                                                                    \
  usingBlockRestrictableMembers;                                                                   \
  using GenericKernel&lt;is_ad&gt;::_qp;                                                                 \
  using GenericKernel&lt;is_ad&gt;::_i;                                                                  \
  using GenericKernel&lt;is_ad&gt;::_j;                                                                  \
  using GenericKernel&lt;is_ad&gt;::_u;                                                                  \
  using GenericKernel&lt;is_ad&gt;::_phi;                                                                \
  using GenericKernel&lt;is_ad&gt;::_test;                                                               \
  using GenericKernel&lt;is_ad&gt;::_q_point;                                                            \
  using GenericKernel&lt;is_ad&gt;::_var;                                                                \
  using GenericKernel&lt;is_ad&gt;::_name;                                                               \
  using GenericKernel&lt;is_ad&gt;::getVar;                                                              \
  using Coupleable::coupled;                                                                       \
  using Coupleable::coupledComponents
</code></pre><a class="moose-source-filename tooltipped modal-trigger" href="#3d01229f-c5a6-4d38-9136-67d4b57b09a7">(moose/framework/include/kernels/GenericKernel.h)</a><p>In addition, templated methods used in a class derived from a templated base class (like in example above) must be prefixed with <code>this-&gt;template</code> to avoid compiler ambiguity, for example, the use of <code>getParam&lt;T&gt;</code> in the <code>BodyForce</code> kernel above</p><pre class="moose-pre" style="max-height:350px;"><code class="language-None">_scale(this-&gt;template getParam&lt;Real&gt;(&quot;value&quot;)),</code></pre></section></section><div class="moose-modal modal" id="f79fa6c7-7c15-42a5-9440-5d9b278da8d1"><div class="modal-content"><h4>(moose/framework/include/materials/GenericConstantMaterial.h)</h4><pre class="moose-pre"><code class="language-cpp">// This file is part of the MOOSE framework
// https://www.mooseframework.org
//
// All rights reserved, see COPYRIGHT for full restrictions
// https://github.com/idaholab/moose/blob/master/COPYRIGHT
//
// Licensed under LGPL 2.1, please see LICENSE for details
// https://www.gnu.org/licenses/lgpl-2.1.html

#pragma once

#include &quot;Material.h&quot;

/**
 * This material automatically declares as material properties whatever is passed to it
 * through the parameters &#x27;prop_names&#x27; and uses the values from &#x27;prop_values&#x27; as the values
 * for those properties.
 *
 * This is not meant to be used in a production capacity... and instead is meant to be used
 * during development phases for ultimate flexibility.
 */
template &lt;bool is_ad&gt;
class GenericConstantMaterialTempl : public Material
{
public:
  static InputParameters validParams();

  GenericConstantMaterialTempl(const InputParameters &amp; parameters);

protected:
  virtual void initQpStatefulProperties() override;
  virtual void computeQpProperties() override;

  const std::vector&lt;std::string&gt; &amp; _prop_names;
  const std::vector&lt;Real&gt; &amp; _prop_values;

  unsigned int _num_props;

  std::vector&lt;GenericMaterialProperty&lt;Real, is_ad&gt; *&gt; _properties;
};

typedef GenericConstantMaterialTempl&lt;false&gt; GenericConstantMaterial;
typedef GenericConstantMaterialTempl&lt;true&gt; ADGenericConstantMaterial;
</code></pre></div><div class="modal-footer"><a class="modal-close btn-flat">Close</a></div></div><div class="moose-modal modal" id="9418e3ef-a3c8-4c83-9441-2fbe528083e4"><div class="modal-content"><h4>(moose/framework/src/materials/GenericConstantMaterial.C)</h4><pre class="moose-pre"><code class="language-cpp">// This file is part of the MOOSE framework
// https://www.mooseframework.org
//
// All rights reserved, see COPYRIGHT for full restrictions
// https://github.com/idaholab/moose/blob/master/COPYRIGHT
//
// Licensed under LGPL 2.1, please see LICENSE for details
// https://www.gnu.org/licenses/lgpl-2.1.html

#include &quot;GenericConstantMaterial.h&quot;

registerMooseObject(&quot;MooseApp&quot;, GenericConstantMaterial);
registerMooseObject(&quot;MooseApp&quot;, ADGenericConstantMaterial);

template &lt;bool is_ad&gt;
InputParameters
GenericConstantMaterialTempl&lt;is_ad&gt;::validParams()
{
  InputParameters params = Material::validParams();
  params.addClassDescription(
      &quot;Declares material properties based on names and values prescribed by input parameters.&quot;);
  params.addRequiredParam&lt;std::vector&lt;std::string&gt;&gt;(
      &quot;prop_names&quot;, &quot;The names of the properties this material will have&quot;);
  params.addRequiredParam&lt;std::vector&lt;Real&gt;&gt;(&quot;prop_values&quot;,
                                             &quot;The values associated with the named properties&quot;);
  params.set&lt;MooseEnum&gt;(&quot;constant_on&quot;) = &quot;SUBDOMAIN&quot;;
  params.declareControllable(&quot;prop_values&quot;);
  return params;
}

template &lt;bool is_ad&gt;
GenericConstantMaterialTempl&lt;is_ad&gt;::GenericConstantMaterialTempl(
    const InputParameters &amp; parameters)
  : Material(parameters),
    _prop_names(getParam&lt;std::vector&lt;std::string&gt;&gt;(&quot;prop_names&quot;)),
    _prop_values(getParam&lt;std::vector&lt;Real&gt;&gt;(&quot;prop_values&quot;))
{
  unsigned int num_names = _prop_names.size();
  unsigned int num_values = _prop_values.size();

  if (num_names != num_values)
    mooseError(
        &quot;Number of prop_names must match the number of prop_values for a GenericConstantMaterial!&quot;);

  _num_props = num_names;

  _properties.resize(num_names);

  for (unsigned int i = 0; i &lt; _num_props; i++)
    _properties[i] = &amp;declareGenericProperty&lt;Real, is_ad&gt;(_prop_names[i]);
}

template &lt;bool is_ad&gt;
void
GenericConstantMaterialTempl&lt;is_ad&gt;::initQpStatefulProperties()
{
  computeQpProperties();
}

template &lt;bool is_ad&gt;
void
GenericConstantMaterialTempl&lt;is_ad&gt;::computeQpProperties()
{
  for (unsigned int i = 0; i &lt; _num_props; i++)
    (*_properties[i])[_qp] = _prop_values[i];
}

template class GenericConstantMaterialTempl&lt;false&gt;;
template class GenericConstantMaterialTempl&lt;true&gt;;
</code></pre></div><div class="modal-footer"><a class="modal-close btn-flat">Close</a></div></div><div class="moose-modal modal" id="08ec6d3e-d651-4826-8bdd-a0d0c26d9a7d"><div class="modal-content"><h4>(moose/framework/include/kernels/BodyForce.h)</h4><pre class="moose-pre"><code class="language-cpp">// This file is part of the MOOSE framework
// https://www.mooseframework.org
//
// All rights reserved, see COPYRIGHT for full restrictions
// https://github.com/idaholab/moose/blob/master/COPYRIGHT
//
// Licensed under LGPL 2.1, please see LICENSE for details
// https://www.gnu.org/licenses/lgpl-2.1.html

#pragma once

#include &quot;GenericKernel.h&quot;

class Function;

/**
 * This kernel implements a generic functional
 * body force term:
 * $ - c \cdof f \cdot \phi_i $
 *
 * The coefficient and function both have defaults
 * equal to 1.0.
 */
template &lt;bool is_ad&gt;
class BodyForceTempl : public GenericKernel&lt;is_ad&gt;
{
public:
  static InputParameters validParams();

  BodyForceTempl(const InputParameters &amp; parameters);

protected:
  virtual GenericReal&lt;is_ad&gt; computeQpResidual() override;

  /// Scale factor
  const Real &amp; _scale;

  /// Optional function value
  const Function &amp; _function;

  /// Optional Postprocessor value
  const PostprocessorValue &amp; _postprocessor;

  // AD/non-AD version of the quadrature point coordinates
  const MooseArray&lt;MooseADWrapper&lt;Point, is_ad&gt;&gt; * _generic_q_point;

  usingGenericKernelMembers;
};

typedef BodyForceTempl&lt;false&gt; BodyForce;
typedef BodyForceTempl&lt;true&gt; ADBodyForce;
</code></pre></div><div class="modal-footer"><a class="modal-close btn-flat">Close</a></div></div><div class="moose-modal modal" id="17e6b763-c8f8-4615-8e0f-2409bffbbbb6"><div class="modal-content"><h4>(moose/framework/src/kernels/BodyForce.C)</h4><pre class="moose-pre"><code class="language-cpp">// This file is part of the MOOSE framework
// https://www.mooseframework.org
//
// All rights reserved, see COPYRIGHT for full restrictions
// https://github.com/idaholab/moose/blob/master/COPYRIGHT
//
// Licensed under LGPL 2.1, please see LICENSE for details
// https://www.gnu.org/licenses/lgpl-2.1.html

#include &quot;BodyForce.h&quot;

// MOOSE
#include &quot;Function.h&quot;
#include &quot;Assembly.h&quot;

registerMooseObject(&quot;MooseApp&quot;, BodyForce);
registerMooseObject(&quot;MooseApp&quot;, ADBodyForce);

template &lt;bool is_ad&gt;
InputParameters
BodyForceTempl&lt;is_ad&gt;::validParams()
{
  InputParameters params = GenericKernel&lt;is_ad&gt;::validParams();
  params.addClassDescription(&quot;Demonstrates the multiple ways that scalar values can be introduced &quot;
                             &quot;into kernels, e.g. (controllable) constants, functions, and &quot;
                             &quot;postprocessors. Implements the weak form $(\\psi_i, -f)$.&quot;);
  params.addParam&lt;Real&gt;(&quot;value&quot;, 1.0, &quot;Coefficient to multiply by the body force term&quot;);
  params.addParam&lt;FunctionName&gt;(&quot;function&quot;, &quot;1&quot;, &quot;A function that describes the body force&quot;);
  params.addParam&lt;PostprocessorName&gt;(
      &quot;postprocessor&quot;, 1, &quot;A postprocessor whose value is multiplied by the body force&quot;);
  params.declareControllable(&quot;value&quot;);
  return params;
}

template &lt;bool is_ad&gt;
BodyForceTempl&lt;is_ad&gt;::BodyForceTempl(const InputParameters &amp; parameters)
  : GenericKernel&lt;is_ad&gt;(parameters),
    _scale(this-&gt;template getParam&lt;Real&gt;(&quot;value&quot;)),
    _function(getFunction(&quot;function&quot;)),
    _postprocessor(getPostprocessorValue(&quot;postprocessor&quot;)),
    _generic_q_point(this-&gt;_use_displaced_mesh ? &amp;this-&gt;_assembly.template genericQPoints&lt;is_ad&gt;()
                                               : nullptr)
{
}

template &lt;bool is_ad&gt;
GenericReal&lt;is_ad&gt;
BodyForceTempl&lt;is_ad&gt;::computeQpResidual()
{
  if (_generic_q_point)
    return -_test[_i][_qp] * _scale * _postprocessor *
           _function.value(_t, (*_generic_q_point)[_qp]);
  else
    return -_test[_i][_qp] * _scale * _postprocessor * _function.value(_t, _q_point[_qp]);
}

template class BodyForceTempl&lt;false&gt;;
template class BodyForceTempl&lt;true&gt;;
</code></pre></div><div class="modal-footer"><a class="modal-close btn-flat">Close</a></div></div><div class="moose-modal modal" id="3d01229f-c5a6-4d38-9136-67d4b57b09a7"><div class="modal-content"><h4>(moose/framework/include/kernels/GenericKernel.h)</h4><pre class="moose-pre"><code class="language-cpp">// This file is part of the MOOSE framework
// https://www.mooseframework.org
//
// All rights reserved, see COPYRIGHT for full restrictions
// https://github.com/idaholab/moose/blob/master/COPYRIGHT
//
// Licensed under LGPL 2.1, please see LICENSE for details
// https://www.gnu.org/licenses/lgpl-2.1.html

#pragma once

#include &quot;Kernel.h&quot;
#include &quot;ADKernel.h&quot;

template &lt;bool is_ad&gt;
class GenericKernel : public Kernel
{
public:
  static InputParameters validParams() { return Kernel::validParams(); };
  GenericKernel(const InputParameters &amp; parameters) : Kernel(parameters) {}
};

template &lt;&gt;
class GenericKernel&lt;true&gt; : public ADKernel
{
public:
  static InputParameters validParams() { return ADKernel::validParams(); };
  GenericKernel(const InputParameters &amp; parameters) : ADKernel(parameters) {}
};

#define usingGenericKernelMembers                                                                  \
  usingFunctionInterfaceMembers;                                                                   \
  usingPostprocessorInterfaceMembers;                                                              \
  usingMooseObjectMembers;                                                                         \
  usingTransientInterfaceMembers;                                                                  \
  usingTaggingInterfaceMembers;                                                                    \
  usingBlockRestrictableMembers;                                                                   \
  using GenericKernel&lt;is_ad&gt;::_qp;                                                                 \
  using GenericKernel&lt;is_ad&gt;::_i;                                                                  \
  using GenericKernel&lt;is_ad&gt;::_j;                                                                  \
  using GenericKernel&lt;is_ad&gt;::_u;                                                                  \
  using GenericKernel&lt;is_ad&gt;::_phi;                                                                \
  using GenericKernel&lt;is_ad&gt;::_test;                                                               \
  using GenericKernel&lt;is_ad&gt;::_q_point;                                                            \
  using GenericKernel&lt;is_ad&gt;::_var;                                                                \
  using GenericKernel&lt;is_ad&gt;::_name;                                                               \
  using GenericKernel&lt;is_ad&gt;::getVar;                                                              \
  using Coupleable::coupled;                                                                       \
  using Coupleable::coupledComponents
</code></pre></div><div class="modal-footer"><a class="modal-close btn-flat">Close</a></div></div></div><div class="col hide-on-med-and-down l2"><div class="toc-wrapper pin-top"><ul class="section table-of-contents"><li><a href="#ae7b022a-cecd-4945-9df8-df3d82557f9a" class="tooltipped" data-position="left" data-tooltip="Materials">Materials</a></li><li><a href="#86a5229b-9554-4809-973b-ed1c571b5c71" class="tooltipped" data-position="left" data-tooltip="Kernels">Kernels</a></li></ul></div></div></div></div></main></div></body><script type="text/javascript" src="../contrib/materialize/materialize.min.js"></script><script type="text/javascript" src="../contrib/clipboard/clipboard.min.js"></script><script type="text/javascript" src="../contrib/prism/prism.min.js"></script><script type="text/javascript" src="../js/init.js"></script><script type="text/javascript" src="../js/navigation.js"></script><script type="text/javascript" src="../contrib/fuse/fuse.min.js"></script><script type="text/javascript" src="../js/search_index.js"></script><script type="text/javascript" src="../js/sqa_moose.js"></script>